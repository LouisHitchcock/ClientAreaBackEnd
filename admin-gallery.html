<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Client Gallery Admin</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <div id="admin-header"></div>

  <div id="admin-ui">
    <h1>All Client Galleries</h1>
    <div style="margin-bottom: 1rem;">
      <a href="addClient.html">
        <button class="primary">âž• Add Client</button>
      </a>
    </div>
    <div id="client-list"></div>
  </div>

  <div id="login-ui" style="display: none;"></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { firebaseConfig } from "./config/firebase-config.js";
    import {
      getAuth,
      signInWithPopup,
      GoogleAuthProvider,
      onAuthStateChanged,
      signOut,
      getIdTokenResult
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth();
    const provider = new GoogleAuthProvider();

    const adminUI = document.getElementById("admin-ui");
    const loginUI = document.getElementById("login-ui");
    const clientList = document.getElementById("client-list");

    async function loadClients() {
      const querySnapshot = await getDocs(collection(db, "clients"));

      if (querySnapshot.empty) {
        clientList.innerHTML = "<p>No clients found.</p>";
        return;
      }

      querySnapshot.forEach((docSnap) => {
        const slug = docSnap.id;
        const data = docSnap.data();

        const container = document.createElement("div");
        container.style.border = "1px solid #ccc";
        container.style.padding = "1rem";
        container.style.marginBottom = "1rem";
        container.style.borderRadius = "8px";
        container.style.backgroundColor = "#f9f9f9";

        container.innerHTML = `
          <p><strong>Title:</strong> ${data.title}</p>
          <p><strong>Slug:</strong> ${slug}</p>
          <p><strong>Date:</strong> ${data.date}</p>
          <p><strong>Location:</strong> ${data.location}</p>
          <a href="clients/index.html?slug=${slug}" target="_blank">
            <button>Visit Gallery</button>
          </a>
        `;

        clientList.appendChild(container);
      });
    }

    function showLogin() {
      adminUI.style.display = "none";
      loginUI.style.display = "flex";
      loginUI.style.flexDirection = "column";
      loginUI.style.alignItems = "center";
      loginUI.style.justifyContent = "center";
      loginUI.style.height = "100vh";

      const loginButton = document.createElement("button");
      loginButton.textContent = "Sign in with Google";
      loginButton.className = "primary";
      loginButton.onclick = () => signInWithPopup(auth, provider);

      loginUI.appendChild(loginButton);
    }

    onAuthStateChanged(auth, async (user) => {
      if (user) {
        const tokenResult = await getIdTokenResult(user);
        if (!tokenResult.claims.admin) {
          alert("Access denied. You are not an admin.");
          signOut(auth).then(() => location.reload());
          return;
        }

        loginUI.style.display = "none";
        adminUI.style.display = "block";

        const header = document.getElementById("admin-header");
        const signOutBtn = document.createElement("button");
        signOutBtn.textContent = "Sign Out";
        signOutBtn.className = "danger signout-btn";
        signOutBtn.onclick = () => signOut(auth).then(() => location.reload());

        header.appendChild(signOutBtn);

        loadClients();
      } else {
        showLogin();
      }
    });
  </script>
</body>
</html>